<project>
    <!-- Convenient ant macros -->
    
    <property name="tmp.dir" value="build/tmp" description="Temporary directory"/>
    <property name="haltonfailure" value="true" description="Whether to halt build if tests fail"/>

    <macrodef name="java-to-jar"
              description="Compile Java source and build a Jar">
        <attribute name="srcdir" description="Directory containg Java source"/>
        <attribute name="destjar" description="Path to Jar"/>
        <attribute name="classpath" description="Anything additional to add on the classpath" default=""/>
        <attribute name="jdk" description="Which JDK version to compile to (e.g. 1.3)"/>
        <sequential>
            <mkdir dir="${tmp.dir}/@{destjar}.contents"/>
            <javac srcdir="@{srcdir}" destdir="${tmp.dir}/@{destjar}.contents" source="@{jdk}" target="@{jdk}">
                <classpath>
                    <fileset dir="lib">
                        <include name="*.jar"/>
                    </fileset>
                    <pathelement path="@{classpath}"/>
                </classpath>
            </javac>
            <jar jarfile="@{destjar}">
                <fileset dir="${tmp.dir}/@{destjar}.contents"/>
                <fileset dir="@{srcdir}">
                    <exclude name="**/*.java"/>
                </fileset>
            </jar>
        </sequential>
    </macrodef>

    <macrodef name="run-tests"
              description="Compile and run tests">
        <attribute name="srcdir" description="Directory containg Java source"/>
        <attribute name="classpath" description="Anything additional to add on the classpath" default=""/>
        <sequential>
            <mkdir dir="${tmp.dir}/@{srcdir}.tests"/>
            <javac srcdir="@{srcdir}" destdir="${tmp.dir}/@{srcdir}.tests">
                <classpath>
                    <fileset dir="lib">
                        <include name="*.jar"/>
                    </fileset>
                    <pathelement path="@{classpath}"/>
                </classpath>
            </javac>
            <junit printsummary="no" fork="no" haltonfailure="${haltonfailure}">
                <formatter type="brief" usefile="no"/>
                <classpath>
                    <fileset dir="lib">
                        <include name="*.jar"/>
                    </fileset>
                    <pathelement path="${tmp.dir}/@{srcdir}.tests"/>
                    <pathelement path="@{classpath}"/>
                    <pathelement path="@{srcdir}"/>
                </classpath>
                <batchtest>
                    <fileset dir="@{srcdir}"/>
                </batchtest>
            </junit>
        </sequential>
    </macrodef>
    
</project>